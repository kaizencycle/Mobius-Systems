name: Agent CI

on:
  pull_request:
    paths:
      - "agents/**"
      - "scripts/agent_ci/**"
      - ".github/workflows/agent-ci.yml"
  workflow_dispatch: {}
  schedule:
    - cron: "17 3 * * *"  # nightly sweep

env:
  PYTHON_VERSION: "3.11"
  MII_FLOOR: "0.95"
  PROM_URL: ${{ secrets.PROMETHEUS_URL }} # e.g. http://mobius-kps-prometheus.mobius.svc:9090
  PROM_QUERY_MII_DEFICIT: 'avg(mobius:mii:deficit_1m{env="prod"})'

jobs:
  anti-nuke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Anti-nuke diff guard (agents/)
        run: |
          base="${{ github.event.pull_request.base.sha || github.sha }}"
          head="${{ github.event.pull_request.head.sha || 'HEAD' }}"
          deletes=$(git diff --name-status "$base" "$head" -- agents | awk '$1=="D"{print $2}' | wc -l)
          total=$(git diff --name-only "$base" "$head" -- agents | wc -l)
          if [ "$deletes" -gt 10 ]; then
            echo "Too many deletions in agents/ ($deletes). Failing."
            exit 1
          fi
          if [ "$total" -gt 500 ]; then
            echo "Change-set too large in agents/ ($total files). Failing."
            exit 1
          fi

  test:
    needs: anti-nuke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with: { python-version: ${{ env.PYTHON_VERSION }} }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-json-report pydantic requests jsonschema pyyaml

      - name: Validate agent manifests
        run: |
          python scripts/agent_ci/run_suite.py validate --root agents --schema agents/agent.schema.json

      - name: Run agent sandbox tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python scripts/agent_ci/run_suite.py test --root agents --out artifacts

      - name: Pull live MII deficit (optional)
        id: mii
        run: |
          if [ -n "${PROM_URL}" ]; then
            q=$(python - <<'PY'
import urllib.parse, os
print(urllib.parse.quote(os.environ["PROM_QUERY_MII_DEFICIT"]))
PY
)
            curl -sS "${PROM_URL}/api/v1/query?query=${q}" | tee artifacts/mii_query.json
            val=$(jq -r '.data.result[0].value[1] // "0"' artifacts/mii_query.json)
            echo "value=$val" >> $GITHUB_OUTPUT
          else
            echo "value=0" >> $GITHUB_OUTPUT
          fi

      - name: Enforce MII floor
        run: |
          DEFICIT="${{ steps.mii.outputs.value }}"
          echo "mii_deficit=${DEFICIT}"
          awk -v d="$DEFICIT" -v floor="${MII_FLOOR}" 'BEGIN{
            if (d+0 > 0) { print "MII below floor (" floor "), deficit=" d; exit 1 }
          }'

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent-ci-artifacts
          path: artifacts/

  attest:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build attestation (deliberation proof + run hashes)
        run: |
          python scripts/agent_ci/run_suite.py attest --root agents --out artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent-attestations
          path: artifacts/
