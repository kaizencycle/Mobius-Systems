name: anti-nuke

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute deletion stats
        id: d
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}
          # Count file deletions
          DELETES=$(git diff --diff-filter=D --name-only $BASE...$HEAD | wc -l | xargs)
          # Count total changed files
          TOTAL=$(git diff --name-only $BASE...$HEAD | wc -l | xargs)
          # Protect critical paths from deletion
          PROTECTED=$(git diff --diff-filter=D --name-only $BASE...$HEAD | grep -E '^(apps|packages|labs|sentinels|docs|infra|\.github)/' | wc -l | xargs || true)

          echo "deletes=$DELETES" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "protected=$PROTECTED" >> $GITHUB_OUTPUT

      - name: Enforce thresholds
        run: |
          DELETES=${{ steps.d.outputs.deletes }}
          TOTAL=${{ steps.d.outputs.total }}
          PROTECTED=${{ steps.d.outputs.protected }}

          # Hard caps
          MAX_DELETES=5
          MAX_DELETE_RATIO=0.15

          # Compute ratio (avoid div by zero)
          if [ "$TOTAL" -eq 0 ]; then 
            RATIO=0
          else 
            RATIO=$(python3 - <<'PY'
import sys
deletes = int(sys.argv[1])
total = int(sys.argv[2])
print(round(deletes / max(1, total), 3))
PY
 "$DELETES" "$TOTAL")
          fi
          
          echo "Deletions: $DELETES / $TOTAL (ratio $RATIO) â€¢ Protected deletions: $PROTECTED"

          FAIL=0
          if [ "$DELETES" -gt "$MAX_DELETES" ]; then 
            echo "::error::Too many deletions ($DELETES > $MAX_DELETES)"
            FAIL=1
          fi
          
          if (( $(echo "$RATIO > $MAX_DELETE_RATIO" | bc -l) )); then 
            echo "::error::Deletion ratio $RATIO exceeds $MAX_DELETE_RATIO"
            FAIL=1
          fi
          
          if [ "$PROTECTED" -gt 0 ]; then 
            echo "::error::Deletion in protected paths detected ($PROTECTED files)"
            FAIL=1
          fi

          if [ "$FAIL" -eq 1 ]; then
            echo ""
            echo "## ðŸš¨ Anti-Nuke Guardrail Blocked This PR"
            echo ""
            echo "**Reason:** This PR exceeds safe deletion thresholds."
            echo ""
            echo "### Deletion Summary"
            echo "- Total deletions: $DELETES"
            echo "- Total changed files: $TOTAL"
            echo "- Deletion ratio: $RATIO"
            echo "- Protected path deletions: $PROTECTED"
            echo ""
            echo "### Limits"
            echo "- Maximum deletions: $MAX_DELETES"
            echo "- Maximum deletion ratio: $MAX_DELETE_RATIO"
            echo "- Protected paths: apps/**, packages/**, labs/**, sentinels/**, docs/**, infra/**, .github/**"
            echo ""
            echo "**Action Required:** Reduce deletions or break into smaller PRs."
            exit 1
          fi

          echo "âœ… Anti-nuke check passed"
