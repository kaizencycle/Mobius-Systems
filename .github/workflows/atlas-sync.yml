name: ATLAS Sync Notification

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, closed, reopened]
  release:
    types: [published, created]

jobs:
  notify-atlas:
    name: Notify ATLAS of Repository Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit details
        id: commit_info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "files_changed=$(git diff --name-only HEAD^ HEAD | wc -l)" >> $GITHUB_OUTPUT

      - name: Categorize changes
        id: categorize
        run: |
          INFRA_CHANGES=$(git diff --name-only HEAD^ HEAD | grep -E '(vercel\.json|\.github/|Dockerfile|render\.yaml|infra/)' | wc -l)
          DOCS_CHANGES=$(git diff --name-only HEAD^ HEAD | grep -E '(README|docs/|\.md)' | wc -l)
          APP_CHANGES=$(git diff --name-only HEAD^ HEAD | grep -E '(apps/|packages/|src/)' | wc -l)

          echo "infra=$INFRA_CHANGES" >> $GITHUB_OUTPUT
          echo "docs=$DOCS_CHANGES" >> $GITHUB_OUTPUT
          echo "app=$APP_CHANGES" >> $GITHUB_OUTPUT

      - name: Notify ATLAS (placeholder)
        env:
          EVENT_TYPE: ${{ github.event_name }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
          SHA_SHORT: ${{ steps.commit_info.outputs.sha_short }}
          AUTHOR: ${{ steps.commit_info.outputs.author }}
          MESSAGE: ${{ steps.commit_info.outputs.message }}
          FILES_CHANGED: ${{ steps.commit_info.outputs.files_changed }}
          INFRA_CHANGES: ${{ steps.categorize.outputs.infra }}
          DOCS_CHANGES: ${{ steps.categorize.outputs.docs }}
          APP_CHANGES: ${{ steps.categorize.outputs.app }}
        run: |
          echo "=== ATLAS SYNC EVENT ==="
          echo "Event: $EVENT_TYPE"
          echo "Ref: $REF"
          echo "Commit: $SHA_SHORT"
          echo "Author: $AUTHOR"
          echo "Message: $MESSAGE"
          echo "Files Changed: $FILES_CHANGED"
          echo "  - Infrastructure: $INFRA_CHANGES"
          echo "  - Documentation: $DOCS_CHANGES"
          echo "  - Application: $APP_CHANGES"
          echo ""
          echo "TODO: Implement webhook to ATLAS sync endpoint"
          echo "curl -X POST \$ATLAS_SYNC_URL/sync/post_repo_sync_ack \\"
          echo "  -H 'Authorization: Bearer \$ATLAS_SYNC_TOKEN' \\"
          echo "  -H 'Content-Type: application/json' \\"
          echo "  -d '{...}'"

      - name: Update cycle badge (on main push)
        if: miithub.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Cycle C-125 confirmed via workflow"
          echo "GI baseline: 0.993"
