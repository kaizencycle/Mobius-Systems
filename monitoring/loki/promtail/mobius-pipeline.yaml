server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: ${LOKI_PUSH_URL:http://loki:3100/loki/api/v1/push}

scrape_configs:
  - job_name: mobius-api-logs
    static_configs:
      - targets: [localhost]
        labels:
          job: mobius-api
          env: ${ENV:prod}
          app: mobius-api
          __path__: /var/log/mobius/api/*.log

    pipeline_stages:
      - json:
          expressions:
            ts: time
            lvl: level
            msg: message
            route: route
            status: status
            duration_ms: duration_ms
            agent: agent
            request_id: request_id
      - timestamp:
          source: ts
          format: RFC3339
      - labels:
          lvl:
          route:
          status:
          agent:
          env:
          app:
      - regex:
          expression: '^(?P<status_family>[0-9])'
          source: status
      - labels:
          status_family:
      - metrics:
          # convert duration_ms to seconds histogram
          mobius_http_request_duration_seconds:
            type: histogram
            description: "Mobius API request duration"
            source: duration_ms
            config:
              buckets: [0.05, 0.1, 0.25, 0.5, 1, 2, 5]
              factor: 0.001
          mobius_http_requests_total:
            type: counter
            description: "Mobius API request count"
            config:
              value: 1
          mobius_http_errors_total:
            type: counter
            description: "Mobius API error count"
            config:
              value: 1
              labels:
                error: "true"
      - drop:
          expression: "(?i)health|metrics"
          source: route
